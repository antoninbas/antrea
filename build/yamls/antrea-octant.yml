# yaml template for octant and antrea-octant-plugin
# Right config parameters and Docker image must be specified.
apiVersion: apps/v1
kind: Deployment
metadata:
  name: antrea-octant
  namespace: kube-system
  labels:
    app: antrea
    component: antrea-octant
spec:
  replicas: 1
  strategy:
    # Ensure the existing Pod is killed before the new one is created.
    type: Recreate
  selector:
    matchLabels:
      app: antrea
      component: antrea-octant
  template:
    metadata:
      labels:
        app: antrea
        component: antrea-octant
    spec:
      nodeSelector:
        # Add the role to support running antrea-octant on specific node
        # In this way, users can see UI via a fixed URL as http://$HOSTNAME:8900
        role: antrea-octant
        # Note: beta.kubernetes.io/os is targeted for removal in K8s v1.18, if running Antrea with 1.18
        # or higher uncomment the following line and remove beta.kubernetes.io/os.
        #kubernetes.io/os: linux
        beta.kubernetes.io/os: linux
      hostNetwork: true
      priorityClassName: system-cluster-critical
      tolerations:
        # Mark it as a critical add-on.
        - key: CriticalAddonsOnly
          operator: Exists
        # Allow it to schedule onto master nodes.
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
      containers:
        - name: antrea-octant
          image: antrea-octant
          imagePullPolicy: IfNotPresent
          env:
            # Octant starts up env
            - name: OCTANT_ACCEPTED_HOSTS
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
              # Port 8900 can be changed according to your set up.
            - name: OCTANT_LISTENER_ADDR
              value: "0.0.0.0:8900"
            - name: OCTANT_DISABLE_OPEN_BROWSER
              value: "true"
              # Change admin.conf to the name of kubeconfig file in your set up.
            - name: KUBECONFIG
              value: "/kube/admin.conf"
          command: ["octant"]
          args: ["-v"]
          ports:
          - containerPort: 8900
          volumeMounts:
            - name: kubeconfig
              mountPath: /kube/
      volumes:
        - name: kubeconfig
          secret:
            secretName: octant-kubeconfig
            defaultMode: 256
